{% extends 'main_layout.html' %}

{% set discount_price = class.class_price * class.class_discount / 100 %}
{% set sale_price = class.class_price - discount_price %}

{% block content %}

<div class="payment-container">

  <p class="pt24">결제</p>

  <p class="sub-title">선택한 클래스</p>

  <div class="payment-select-class">


    <div class="payment-img">
      <img src="{{class.class_img}}">
    </div>


    <div class="payment-title-wrapper">

      <p class="payment-class-title">{{class.class_title}}</p>

      <ul>
        <li>· 수강기간 16주 키트 배송기간이 포함되어있습니다.</li>
        <li>· 키트 할인 안내 추후 키트만 구매 시 기본 할인이 적용되지 않습니다.</li>
      </ul>
      <p class="payment-price">{{class.class_price.toLocaleString('ko-KR')}}원</p>

    </div>

  </div>

  <div class="dividing-line"></div>

  <p class="sub-title">결제 금액</p>

  <div class="spacing-30"></div>

  <div class="price-line">
    <span class="price-title">상품 금액</span>
    <span class="price-value">{{class.class_price.toLocaleString('ko-KR')}}원</span>
  </div>
  <div class="price-line">
    <span class="price-title red">할인 금액</span>
    <span class="price-value red">- {{discount_price.toLocaleString('ko-KR')}}원</span>
  </div>
  <div class="price-line total-price">
    <span class="price-title">총 금액</span>
    <span class="price-value">{{sale_price.toLocaleString('ko-KR')}}원</span>
  </div>

  <div class="spacing-30"></div>

  <div class="dividing-line"></div>

  <!-- <p class="sub-title">결제 수단</p> -->

<div class="big-button-wrapper">
    <button class="submit-button" id="payment-submit" onclick="requestPay()">결제하기</button>
    <input type="button" class="submit-button" id="payment-submit" value="취소" onclick="history.back()">
</div>

</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<!-- <script type="text/javascript" src="/javascripts/payment.js"></script> -->

<script type="text/javascript">
  IMP.init('imp00447746');

  function requestPay() {
      IMP.request_pay({
          pg: 'html5_inicis',
          pay_method: 'card',
          merchant_uid: 'merchant_' + new Date().getTime(),
          name: '온뜰 강의 구매',
          amount: "{{sale_price}}",
          buyer_email: "{{user.user_email}}",
          buyer_name: "{{user.user_nickname}}",
          buyer_tel: "{{user.user_phone}}",
      }, function(rsp) {
          if (rsp.success) {
              jQuery.ajax({
                  url: "/class/{{class.id}}/payment/complete",
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                      "Accept": "application/json"
                  },
                  data: JSON.stringify({
                      imp_uid: rsp.imp_uid,
                      merchant_uid: rsp.merchant_uid
                  })
              }).done(function(data) {
                  // 가맹점 서버 결제 API 성공시 로직
                  switch (data.status) {
                      case 'vbankIssued':
                          // 가상계좌 발급 시 로직
                          alert('가상계좌가 발급되었습니다');
                          break;
                      case 'success':
                          alert('결제 성공');
                          break;
                  }
                  jQuery.ajax({
                    url: "/mail/{{class.id}}",
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Accept": "application/json"
                    },
                  });
                  window.location.href='/mypage';
              });
          } else {
              alert(rsp.error_msg);
          }
      });
  }
</script>

{% endblock %}
